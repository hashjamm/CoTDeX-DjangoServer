<!DOCTYPE html>
<html lang="ko">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì¼ ì§ˆë³‘ ê·¸ë˜í”„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.0/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/layout-base/layout-base.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cose-base/cose-base.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-fcose/cytoscape-fcose.min.js"></script>
    <script src="https://unpkg.com/cytoscape-cose-bilkent/cytoscape-cose-bilkent.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/pubmedbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/graph_page.css' %}">

    <style>
    /* ====== ì™¼ìª½ ì‚¬ì´ë“œë°” ë””ìì¸ ê°œì„  ====== */
    #disease-list {
        width: 260px;
        height: 100vh;
        background: #ffffff;
        border-right: 1px solid #ddd;
        padding: 16px;
        box-shadow: 2px 0 6px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        position: fixed;
        left: 0;
        top: 60px;
        z-index: 1500;
        overflow-y: auto;
        transition: left 0.3s ease-in-out;
    }

    #disease-list h1 {
        font-size: 17px;
        font-weight: bold;
        color: #333;
        text-align: center;
        margin-bottom: 16px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }

    .filter-info,
    #node-list-section {
        background: #f9f9f9;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 14px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .filter-info p,
    #node-list-section li {
        font-size: 13px;
        color: #333;
        margin: 4px 0;
    }

    #disease-list label {
        font-size: 13px;
        color: #444;
        font-weight: 600;
        margin-top: 8px;
        display: block;
    }

    #disease-list input[type="range"] {
        width: 100%;
        margin-bottom: 10px;
    }

    #disease-list input[type="number"],
    #disease-list select {
        width: 100%;
        padding: 6px 8px;
        font-size: 13px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 8px;
        background: #fff;
        box-sizing: border-box;
    }

    #disease-list button {
        padding: 8px;
        font-size: 13px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 8px;
        transition: background-color 0.2s;
    }

    #disease-list button:hover {
        background-color: #0056b3;
    }

    #node-list-section h3 {
        font-size: 13px;
        font-weight: bold;
        color: #444;
        margin-bottom: 8px;
    }

    #node-list {
        max-height: 200px;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 12px;
    }

    #node-list li {
        padding: 4px 6px;
        border-bottom: 1px solid #eee;
        cursor: default;
    }

    #node-list li:last-child {
        border-bottom: none;
    }

    #node-list li:hover {
        background-color: #f0f0f0;
    }

    /* ====== ë°˜ì‘í˜• ====== */
    @media (max-width: 1500px) {
        #disease-list {
            left: -420px !important;
            height: calc(100vh - 60px) !important;
        }
        #disease-list.show {
            left: 0 !important;
        }
        .toggle-left-button {
            display: block;
        }
        #cy { flex: 1 !important; width: 100% !important; }
        .toggle-left-button { top: 70px !important; left: 10px !important; }
    }
    </style>
</head>
<body>
    <header>
        <a href="{% url 'visualization_home' %}" class="logo">CoTDeX</a>
        <div class="nav-buttons">
            {% if user.is_authenticated %}
                <span>{{ user.username }}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</span>
                <button onclick="location.href='{% url 'mypage' %}'">ë§ˆì´í˜ì´ì§€</button>
                <button onclick="location.href='{% url 'logout' %}'">ë¡œê·¸ì•„ì›ƒ</button>
            {% else %}
                <button onclick="location.href='{% url 'login' %}'">ë¡œê·¸ì¸</button>
                <button onclick="location.href='{% url 'signup' %}'">íšŒì›ê°€ì…</button>
            {% endif %}
        </div>
    </header>
    <button class="toggle-left-button" onclick="toggleSidebar()">â˜° ì§ˆë³‘ ëª©ë¡</button>
    <div id="disease-list">
        <h1>ë‹¨ì¼ ì§ˆë³‘ ê·¸ë˜í”„</h1>
        <div class="filter-info">
            <p><b>ì„ íƒí•œ ì§ˆë³‘:</b> <span id="selected-disease">{{ disease_code }}</span></p>
        </div>
        <label for="follow-up-slider"><b>Follow-Up:</b> <span id="follow-up-text">{{ follow_up }}</span></label>
        <input type="range" id="follow-up-slider" min="1" max="10" step="1" value="{{ follow_up }}" oninput="updateFollowUpValue(this.value); updateGraph();">
        <label for="rr-min">RR Values Min & Max</label>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="rr-min" step="0.1" value="{{ rr_min }}" oninput="updateGraph()" style="flex: 1;">
            <input type="number" id="rr-max" step="0.1" value="{{ rr_max }}" oninput="updateGraph()" style="flex: 1;">
        </div>
        <label>Chi-Square & Fisher P-Values:</label>
        <div style="display: flex; gap: 10px;">
            <select id="chisq-p" onchange="updateGraph()">
                <option value="0.5" {% if chisq_p == 0.5 %}selected{% endif %}>â‰¤ 0.5</option>
                <option value="0.05" {% if chisq_p == 0.05 %}selected{% endif %}>â‰¤ 0.05</option>
                <option value="0.005" {% if chisq_p == 0.005 %}selected{% endif %}>â‰¤ 0.005</option>
                <option value="0.0001" {% if chisq_p == 0.0001 %}selected{% endif %}>â‰¤ 0.0001</option>
            </select>
            <select id="fisher-p" onchange="updateGraph()">
                <option value="0.5" {% if fisher_p == 0.5 %}selected{% endif %}>â‰¤ 0.5</option>
                <option value="0.05" {% if fisher_p == 0.05 %}selected{% endif %}>â‰¤ 0.05</option>
                <option value="0.005" {% if fisher_p == 0.005 %}selected{% endif %}>â‰¤ 0.005</option>
                <option value="0.0001" {% if fisher_p == 0.0001 %}selected{% endif %}>â‰¤ 0.0001</option>
            </select>
        </div>
        <br/>
        <div id="node-list-section" class="filter-info" style="max-height: 250px; overflow-y: auto;">
            <h3>ê´€ë ¨ ë…¸ë“œ ëª©ë¡</h3>
            <ul id="node-list" style="list-style-type: none; padding: 0;">
                {% for node in node_names %}
                    <li style="padding: 5px; border-bottom: 1px solid #eee;">{{ node }}</li>
                {% endfor %}
            </ul>
        </div>
        <!-- ë²„íŠ¼ ê·¸ë£¹ div margin-top ì¡°ì • -->
        <div style="display: flex; flex-direction: row; gap: 8px; justify-content: center; align-items: center; margin-top: 10px;">
            <button id="save-graph-btn" style="width:45%;background:#007bff;color:#fff;padding:8px 0;border:none;border-radius:4px;font-size:14px;cursor:pointer;">ê·¸ë˜í”„ ì €ì¥í•˜ê¸°</button>
            <button onclick="window.history.back()" style="width:45%;background:#007bff;color:#fff;padding:8px 0;border:none;border-radius:4px;font-size:14px;cursor:pointer;">ë’¤ë¡œ ê°€ê¸°</button>
        </div>
    </div>

    <div id="cy"></div>
    
    <!-- ì˜¤ë¥¸ìª½ ìƒì„¸ ì •ë³´ ì‚¬ì´ë“œë°” (í•„ìš”ì‹œ) -->
    <div id="info-sidebar">
        <div class="info-sidebar-content">
            <h3 id="sidebar-title">ìƒì„¸ ì •ë³´</h3>
            <div id="sidebar-body">
                <p><strong>ICD-10:</strong> <span id="node-icd10"></span></p>
                <p><strong>Group:</strong> <span id="node-group"></span></p>
                <!-- ìƒì„¸ ì •ë³´ ë° ì°¨íŠ¸ ì˜ì—­ -->
            </div>
        </div>
    </div>
    <div id="pubmed-results"></div>
    <!-- í•˜ë‹¨ PubMed ë…¼ë¬¸ ìŠ¬ë¼ì´ë“œ (í•„ìš”ì‹œ) -->
    <div id="pubmed-slide">
        <div id="pubmed-slide-header">
            <span>ğŸ“š ê´€ë ¨ ë…¼ë¬¸</span>
            <button onclick="closePubmed()">ë‹«ê¸°</button>
        </div>
        <div id="pubmed-slide-body">
            <p>ë…¼ë¬¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            var sidebar = document.getElementById('disease-list');
            sidebar.classList.toggle('show');
        }
    
        function updateNodeList(nodeNames) {
            const nodeListElement = document.getElementById("node-list");
            nodeListElement.innerHTML = "";
            nodeNames.forEach(name => {
                const li = document.createElement("li");
                li.textContent = name;
                nodeListElement.appendChild(li);
            });
        }
    
        document.addEventListener("DOMContentLoaded", function () {
            const selectedDisease = document.getElementById("selected-disease").innerText;
    
            const layoutOptions = {
                name: 'fcose',
                animate: true,
                fit: true,
                padding: 30,
                nodeDimensionsIncludeLabels: true,
                nodeRepulsion: 150000,
                uniformNodeDimensions: false,
                idealEdgeLength: 300,
                edgeElasticity: 0.2,
                gravity: 1.5,
                gravityRangeCompound: 2.0,
                gravityCompound: 2.0,
                nestingFactor: 0.8,
                tile: true,
                randomize: true,
                quality: "proof",
                numIter: 8000
            };
    
            let cy = cytoscape({
                container: document.getElementById('cy'),
                elements: {
                    nodes: {{ nodes|safe }},
                    edges: {{ edges|safe }}
                },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(id)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'color': '#000',
                            'font-size': '12px',
                            'width': 'data(width)',
                            'height': 'data(height)',
                            'shape': 'rectangle'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#ccc',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-color': '#ccc',
                            'curve-style': 'bezier'
                        }
                    }
                ],
                layout: layoutOptions,
                zoom: 1.3
            });
    
            cy.on('layoutstop', () => {
                cy.fit(null, 20);
                cy.zoom(1.4);
                cy.center();
            });
    
            function fetchGraphData() {
                const followUp = document.getElementById("follow-up-slider").value;
                const rrMin = document.getElementById("rr-min").value;
                const rrMax = document.getElementById("rr-max").value;
                const chisq = document.getElementById("chisq-p").value;
                const fisher = document.getElementById("fisher-p").value;
    
                fetch(`/network/single_disease_graph/?disease=${selectedDisease}&follow_up=${followUp}&rr_values_min=${rrMin}&rr_values_max=${rrMax}&chisq_p_values=${chisq}&fisher_p_values=${fisher}`, {
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert("âŒ ì˜¤ë¥˜: " + data.error);
                        return;
                    }
                    cy.elements().remove();
                    cy.add(data.nodes);
                    cy.add(data.edges);
                    cy.layout(layoutOptions).run();
                    updateNodeList(data.node_names);
                })
                .catch(err => {
                    console.error("âŒ ê·¸ë˜í”„ ë°ì´í„° ì˜¤ë¥˜:", err);
                });
            }
    
            window.updateGraph = fetchGraphData;
            

                        // === ì—¬ê¸°ì„œ ë°”ë¡œ ì´ë²¤íŠ¸ ë“±ë¡! ===
                        cy.on('tap', 'node', function (evt) {
                const node = evt.target;
                const nodeId = node.id();
                const nodeLabel = node.data('label');
                const sidebarBody = document.getElementById("sidebar-body");
                sidebarBody.innerHTML = `<p><strong>ë…¸ë“œ ì½”ë“œ:</strong> ${nodeId}</p><p><strong>ì§ˆë³‘ ì´ë¦„:</strong> ${nodeLabel}</p><div class="pubmed-button-container"><button id="pubmed-button" onclick="loadPubmed('${nodeId}')">ê´€ë ¨ ë…¼ë¬¸ ë³´ê¸°</button></div><div class="graph-box"><h4>ì„±ë³„ ë¹„ìœ¨</h4><canvas id="genderChart"></canvas></div><div class="graph-box"><h4>ì—°ë ¹ ë¶„í¬</h4><canvas id="ageBarChart"></canvas></div><div class="graph-box"><h4>ì§€ì—­ ë¶„í¬</h4><canvas id="sidoChart"></canvas></div><div class="graph-box"><h4>ì†Œë“ ìˆ˜ì¤€ ë¶„í¬</h4><canvas id="incomeChart"></canvas></div><div class="graph-box"><h4>ì„±ë³„ Ã— ì—°ë ¹</h4><canvas id="sexAgeChart"></canvas></div><div class="graph-box"><h4>ì„±ë³„ Ã— ì†Œë“</h4><canvas id="sexIncomeChart"></canvas></div><div class="graph-box"><h4>ì„±ë³„ Ã— ì§€ì—­</h4><canvas id="sexSidoChart"></canvas></div>`;
                document.getElementById("info-sidebar").classList.add("open");
                fetch(`/network/get_detail_info/?type=node&node_id=${nodeId}`)
                    .then(response => response.json())
                    .then(json => {
                        if (json.error) {
                            sidebarBody.innerHTML = `<p><strong>${nodeId}</strong></p><p>${json.error}</p>`;
                            return;
                        }
                        const d = json.data;
                        const sex = d.sex || {};
                        const age = d.age || {};
                        const ctrb = d.ctrb || {};
                        const sido = d.sido || {};
                        const sexAge = d.sex_age || {};
                        const sexCtrb = d.sex_ctrb || {};
                        const sexSido = d.sex_sido || {};
                        const ageLabels = Object.keys(age);
                        const incomeLabels = Object.keys(ctrb);
                        const sidoLabels = Object.keys(sido);
                        const maleIncome = incomeLabels.map(i => Number(d.sex_ctrb["1"]?.[Number(i)] || 0));
                        const femaleIncome = incomeLabels.map(i => Number(d.sex_ctrb["2"]?.[Number(i)] || 0));
                        const maleSido = sidoLabels.map(i => Number(d.sex_sido["1"]?.[Number(i)] || 0));
                        const femaleSido = sidoLabels.map(i => Number(d.sex_sido["2"]?.[Number(i)] || 0));
                        const maleAge = ageLabels.map(i => Number(d.sex_age["1"]?.[Number(i)] || 0));
                        const femaleAge = ageLabels.map(i => Number(d.sex_age["2"]?.[Number(i)] || 0));
                        // ì°¨íŠ¸ ê·¸ë¦¬ê¸° (Chart.js)
                        new Chart(document.getElementById('genderChart'), {
                            type: 'pie',
                            data: { labels: ['ë‚¨ì„±', 'ì—¬ì„±'], datasets: [{ data: [sex['1'] || 0, sex['2'] || 0], backgroundColor: ['#4e79a7', '#f28e2b'] }] },
                            options: { responsive: true }
                        });
                        new Chart(document.getElementById('ageBarChart'), {
                            type: 'bar',
                            data: { labels: ageLabels, datasets: [{ label: 'ì—°ë ¹ ë¶„í¬', data: ageLabels.map(a => age[a]), backgroundColor: '#4e79a7' }] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('sexAgeChart'), {
                            type: 'bar',
                            data: { labels: ageLabels, datasets: [ { label: 'ë‚¨ì„±', data: maleAge, backgroundColor: '#4e79a7' }, { label: 'ì—¬ì„±', data: femaleAge, backgroundColor: '#f28e2b' } ] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('sidoChart'), {
                            type: 'bar',
                            data: { labels: sidoLabels, datasets: [{ label: 'ì§€ì—­ ë¶„í¬', data: sidoLabels.map(s => sido[s]), backgroundColor: '#f28e2b' }] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('sexSidoChart'), {
                            type: 'bar',
                            data: { labels: sidoLabels, datasets: [ { label: 'ë‚¨ì„±', data: maleSido, backgroundColor: '#4e79a7' }, { label: 'ì—¬ì„±', data: femaleSido, backgroundColor: '#f28e2b' } ] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('incomeChart'), {
                            type: 'bar',
                            data: { labels: incomeLabels, datasets: [{ label: 'ì†Œë“ ìˆ˜ì¤€ ë¶„í¬', data: incomeLabels.map(i => ctrb[i]), backgroundColor: '#59a14f' }] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('sexIncomeChart'), {
                            type: 'bar',
                            data: { labels: incomeLabels, datasets: [ { label: 'ë‚¨ì„±', data: maleIncome, backgroundColor: '#4e79a7' }, { label: 'ì—¬ì„±', data: femaleIncome, backgroundColor: '#f28e2b' } ] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                    })
                    .catch(err => {
                        console.error("Node info fetch error:", err);
                        sidebarBody.innerHTML = `<p><strong>${nodeId}</strong></p><p>ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>`;
                    });
            });
            cy.on('tap', 'edge', function (evt) {
                const edge = evt.target;
                const source = edge.source().id();
                const target = edge.target().id();
                const sourceLabel = edge.source().data('label');
                const targetLabel = edge.target().data('label');
                const followUp = document.getElementById("follow-up-slider").value;
                const rrMin = document.getElementById("rr-min").value;
                const rrMax = document.getElementById("rr-max").value;
                const chisq = document.getElementById("chisq-p").value;
                const fisher = document.getElementById("fisher-p").value;
                const sidebarBody = document.getElementById("sidebar-body");
                sidebarBody.innerHTML = `<p><strong>Edge:</strong> ${source} (${sourceLabel}) â†’ ${target} (${targetLabel})<div class=\"pubmed-button-container\"><button id=\"pubmed-button\" onclick=\"loadPubmed('${source}', '${target}')\">ê´€ë ¨ ë…¼ë¬¸ ë³´ê¸°</button></div><div class=\"graph-box\"><h4>ì„±ë³„ ë¹„ìœ¨</h4><canvas id=\"genderEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì—°ë ¹ ë¶„í¬</h4><canvas id=\"edgeAgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì§€ì—­ ë¶„í¬</h4><canvas id=\"sidoEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì†Œë“ ìˆ˜ì¤€ ë¶„í¬</h4><canvas id=\"incomeEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì„±ë³„ Ã— ì—°ë ¹</h4><canvas id=\"sexAgeEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì„±ë³„ Ã— ì§€ì—­</h4><canvas id=\"sexSidoEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì„±ë³„ Ã— ì†Œë“</h4><canvas id=\"sexIncomeEdgeChart\"></canvas></div>`;
                document.getElementById("info-sidebar").classList.add("open");
                const url = `/network/get_detail_info/?type=edge&source=${source}&target=${target}&follow_up=${followUp}&rr_values_min=${rrMin}&rr_values_max=${rrMax}&chisq_p_values=${chisq}&fisher_p_values=${fisher}`;
                fetch(url)
                    .then(response => response.json())
                    .then(json => {
                        if (json.error) {
                            sidebarBody.innerHTML = `<p><strong>Edge</strong>: ${source} â†’ ${target}</p><p>${json.error}</p>`;
                            return;
                        }
                        const d = json.data;
                        const sex = d.sex || {};
                        const age = d.age || {};
                        const ctrb = d.ctrb || {};
                        const sido = d.sido || {};
                        const sexAge = d.sex_age || {};
                        const sexCtrb = d.sex_ctrb || {};
                        const sexSido = d.sex_sido || {};
                        const ageLabels = Object.keys(age);
                        const incomeLabels = Object.keys(ctrb);
                        const sidoLabels = Object.keys(sido);
                        const maleAge = ageLabels.map(i => Number(sexAge["1"]?.[i] || 0));
                        const femaleAge = ageLabels.map(i => Number(sexAge["2"]?.[i] || 0));
                        const maleIncome = incomeLabels.map(i => Number(sexCtrb["1"]?.[i] || 0));
                        const femaleIncome = incomeLabels.map(i => Number(sexCtrb["2"]?.[i] || 0));
                        const maleSido = sidoLabels.map(i => Number(sexSido["1"]?.[i] || 0));
                        const femaleSido = sidoLabels.map(i => Number(sexSido["2"]?.[i] || 0));
                        sidebarBody.innerHTML = `<p><strong>Edge:</strong> ${source} (${sourceLabel}) â†’ ${target} (${targetLabel})<div class=\"pubmed-button-container\"><button id=\"pubmed-button\" onclick=\"loadPubmed('${source}', '${target}')\">ê´€ë ¨ ë…¼ë¬¸ ë³´ê¸°</button></div><div class=\"graph-box\"><h4>ì„±ë³„ ë¹„ìœ¨</h4><canvas id=\"genderEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì—°ë ¹ ë¶„í¬</h4><canvas id=\"edgeAgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì§€ì—­ ë¶„í¬</h4><canvas id=\"sidoEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì†Œë“ ìˆ˜ì¤€ ë¶„í¬</h4><canvas id=\"incomeEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì„±ë³„ Ã— ì—°ë ¹</h4><canvas id=\"sexAgeEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì„±ë³„ Ã— ì§€ì—­</h4><canvas id=\"sexSidoEdgeChart\"></canvas></div><div class=\"graph-box\"><h4>ì„±ë³„ Ã— ì†Œë“</h4><canvas id=\"sexIncomeEdgeChart\"></canvas></div>`;
                        new Chart(document.getElementById('genderEdgeChart'), {
                            type: 'pie',
                            data: { labels: ['ë‚¨ì„±', 'ì—¬ì„±'], datasets: [{ data: [sex["1"] || 0, sex["2"] || 0], backgroundColor: ['#4e79a7', '#f28e2b'] }] },
                            options: { responsive: true }
                        });
                        new Chart(document.getElementById('edgeAgeChart'), {
                            type: 'bar',
                            data: { labels: ageLabels, datasets: [{ label: 'ì—°ë ¹ ë¶„í¬', data: ageLabels.map(i => age[i]), backgroundColor: '#4e79a7' }] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('sexAgeEdgeChart'), {
                            type: 'bar',
                            data: { labels: ageLabels, datasets: [ { label: 'ë‚¨ì„±', data: maleAge, backgroundColor: '#4e79a7' }, { label: 'ì—¬ì„±', data: femaleAge, backgroundColor: '#f28e2b' } ] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('sidoEdgeChart'), {
                            type: 'bar',
                            data: { labels: sidoLabels, datasets: [{ label: 'ì§€ì—­ ë¶„í¬', data: sidoLabels.map(i => sido[i]), backgroundColor: '#f28e2b' }] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('sexSidoEdgeChart'), {
                            type: 'bar',
                            data: { labels: sidoLabels, datasets: [ { label: 'ë‚¨ì„±', data: maleSido, backgroundColor: '#4e79a7' }, { label: 'ì—¬ì„±', data: femaleSido, backgroundColor: '#f28e2b' } ] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('incomeEdgeChart'), {
                            type: 'bar',
                            data: { labels: incomeLabels, datasets: [{ label: 'ì†Œë“ ë¶„í¬', data: incomeLabels.map(i => ctrb[i]), backgroundColor: '#59a14f' }] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                        new Chart(document.getElementById('sexIncomeEdgeChart'), {
                            type: 'bar',
                            data: { labels: incomeLabels, datasets: [ { label: 'ë‚¨ì„±', data: maleIncome, backgroundColor: '#4e79a7' }, { label: 'ì—¬ì„±', data: femaleIncome, backgroundColor: '#f28e2b' } ] },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                    })
                    .catch(err => {
                        console.error("Edge info fetch error:", err);
                        sidebarBody.innerHTML = `<p><strong>Edge</strong>: ${source} â†’ ${target}</p><p>ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>`;
                    });
            });
            cy.on('tap', function (evt) {
                if (evt.target === cy) {
                    document.getElementById("info-sidebar").classList.remove("open");
                }
            });
            // PubMed ë…¼ë¬¸ ìŠ¬ë¼ì´ë“œ í•¨ìˆ˜
            window.loadPubmed = function(sourceId, targetId = null) {
                const slide = document.getElementById("pubmed-slide");
                const body = document.getElementById("pubmed-slide-body");
                slide.classList.add("show");
                body.innerHTML = "<p>ë…¼ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
                let url = '';
                if (targetId && sourceId !== targetId) {
                    url = `/network/search_pubmed/?source=${sourceId}&target=${targetId}`;
                } else {
                    url = `/network/search_pubmed/?code=${sourceId}`;
                }
                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (data.results?.length) {
                            body.innerHTML = data.results.map(p => `<p><a href="${p.url}" target="_blank">${p.title}</a></p>`).join('');
                        } else {
                            body.innerHTML = "<p>ê´€ë ¨ ë…¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                        }
                    })
                    .catch(err => {
                        console.error("PubMed fetch error:", err);
                        body.innerHTML = "<p>ë…¼ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
                    });
            }
            
            window.updateFollowUpValue = function (val) {
                document.getElementById("follow-up-text").innerText = val;
            };

            // === ê·¸ë˜í”„ ì €ì¥í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° ===
            var saveBtn = document.getElementById('save-graph-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    const title = prompt('ê·¸ë˜í”„ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:');
                    if (!title) return;
                    const memo = prompt('ê·¸ë˜í”„ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ):') || '';
                    // í•„í„°ê°’ ì¶”ì¶œ
                    const fu = document.getElementById('follow-up-slider').value;
                    const rr_min = document.getElementById('rr-min').value;
                    const rr_max = document.getElementById('rr-max').value;
                    const chisq_p = document.getElementById('chisq-p').value;
                    const fisher_p = document.getElementById('fisher-p').value;
                    // ì§ˆë³‘ ì´ë¦„(ë‹¨ì¼)
                    const disease_names = document.getElementById('selected-disease').innerText;
                    fetch('/network/save_graph/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            title,
                            memo,
                            fu,
                            rr_min,
                            rr_max,
                            chisq_p,
                            fisher_p,
                            disease_names,
                            graph_type: 'single'
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert('ê·¸ë˜í”„ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        } else {
                            alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì˜¤ë¥˜'));
                        }
                    });
                });
            }
        });
    </script>
    <script src="{% static 'js/graph_page.js' %}?v=20250715"></script>        

</body>
</html>
